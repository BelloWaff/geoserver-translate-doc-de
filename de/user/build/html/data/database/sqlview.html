
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <title>SQL Views &mdash; GeoServer 2.2.x User Manual</title>
  <link rel="stylesheet" href="../../_static/blueprint/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="../../_static/blueprint/print.css" type="text/css" media="print" /> 
  <!--[if IE]>
  <link rel="stylesheet" href="../../_static/blueprint/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->
  <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.2.x',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html'
    };
  </script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/searchtools.js"></script>
  <script type="text/javascript" src="../../searchindex.js"></script>
      <link rel="top" title="GeoServer 2.2.x User Manual" href="../../index.html" />
      <link rel="up" title="Working with Databases" href="index.html" />
      <link rel="next" title="Controlling feature ID generation in spatial databases" href="primarykey.html" />
      <link rel="prev" title="JNDI" href="jndi.html" />
</head>
<body class="data/database/sqlview">
  <div id="header" class="selfclear">
    <div class="wrap selfclear">
      <div id="logo"><a href="../../index.html">GeoServer 2.2.x User Manual</a></div>
      <ul id="top-nav">
        <li class="first"><a href="http://geoserver.org/display/GEOS/What+is+Geoserver">About</a></li>
        <li><a href="http://blog.geoserver.org/">Blog</a></li>
        <li><a href="http://geoserver.org/display/GEOS/Download">Download</a></li>
        <li><a href="../../index.html">Documentation</a></li>
      </ul>
        <form id="quick-search" action="../../search.html" method="get">
          <fieldset>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <input id="quick-search-query" type="text" name="q" accessKey="q" name="searchQuery.queryString" size="25" value="Search Documentation&hellip;" size="20" tabindex="3" onblur="if(this.value=='') this.value='Search Documentation&hellip;';" onfocus="if(this.value=='Search Documentation&hellip;') this.value='';" />
            <input id="quick-search-submit" type="image" value="Search" src="../../_static/chrome/search_icon_green.png" />
          </fieldset>
        </form>
    </div><!-- /.wrap -->
  </div><!-- /#header -->
  <div id="main">
    <div class="wrap selfclear">
      <div id="content">
<ul id="breadcrumbs">
  
  <li><a href="../../index.html">GeoServer 2.2.x User Manual</a> &raquo;</li>
  <li><a href="index.html" accesskey="U">Working with Databases</a> &raquo;</li>
  <li>SQL Views</li>
</ul>
<ul id="relatedlinks" class="selfclear">
  <li class="first">
    <a href="primarykey.html" title="Controlling feature ID generation in spatial databases"
       accesskey="N">next</a></li>
  <li>
    <a href="jndi.html" title="JNDI"
       accesskey="P">previous</a>|</li>
</ul>
        
  <div class="section" id="sql-views">
<span id="id1"></span><h1>SQL Views<a class="headerlink" href="#sql-views" title="Permalink to this headline">¶</a></h1>
<p>The traditional way to access database data is is to configure layers against either tables or database views.
Starting with GeoServer 2.1.0, layers can also be defined as SQL Views.
SQL Views allow executing a custom SQL query on each request to the layer.
This avoids the need to create a database view for complex queries.</p>
<p>Even more usefully, SQL View queries can be parameterized via string substitution.
Parameter values can be supplied in both WMS and WFS requests.
Default values can be supplied for parameters, and input values can be validated by Regular Expressions
to eliminate the risk of SQL injection attacks.</p>
<p>SQL Views are read-only, and thus cannot be updated by WFS-T transactions.</p>
<div class="section" id="creating-a-sql-view">
<h2>Creating a SQL View<a class="headerlink" href="#creating-a-sql-view" title="Permalink to this headline">¶</a></h2>
<p>In order to create a SQL View the administrator invokes the <em class="guilabel">Create new layer</em> page.
When a database store is selected, the usual list of tables and views available for publication appears,
A link <em class="guilabel">Configure new SQL view...</em> also appears:</p>
<div class="figure align-center">
<img alt="../../_images/createsqlview.png" src="../../_images/createsqlview.png" />
</div>
<p>Selecting the <em class="guilabel">Configure new SQL view...</em> link opens a new page where the SQL view query can be specified:</p>
<div class="figure align-center">
<img alt="../../_images/createsql.png" src="../../_images/createsql.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The query can be any SQL statement that is valid as a subquery in a FROM clause (that is, <tt class="docutils literal"><span class="pre">select</span> <span class="pre">*</span> <span class="pre">from</span> <span class="pre">(&lt;the</span> <span class="pre">sql</span> <span class="pre">view&gt;)</span> <span class="pre">[as]</span> <span class="pre">vtable</span></tt>).
This is the case for most SQL statements, but in some databases special syntax may be needed to call stored procedures.
Also, all the columns returned by the SQL statement must have names.
In some databases alias names are required for function calls.</p>
</div>
<p>When a valid SQL query has been entered, press the <em class="guilabel">Refresh</em> link in the <strong>Attributes</strong> table to get the list of the attribute columns determined from the query:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-attributes.png" src="../../_images/sqlview-attributes.png" />
</div>
<p>GeoServer attempts to determine the geometry column type and the native SRID, but these should be verified and corrected if necessary.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Having a correct SRID (spatial reference id) is essential for spatial queries to work.
In many spatial databases the SRID is equal to the EPSG code for the specific spatial reference system, but this is not always the case (for instance, Oracle has a number of non-EPSG SRID codes).</p>
</div>
<p>If stable feature ids are desired for the view&#8217;s features, one or more columns providing a unique id for the features should be checked in the <strong>Identifier</strong> column.
Always ensure these attributes generate a unique key, or filtering and WFS requests will not work correctly.</p>
<p>Once the query and the attribute details are defined, press <em class="guilabel">Save</em>.
The usual <em class="guilabel">New Layer</em> configuration page will appear.
If further changes to the view are required, the page has a link to the SQL View editor at the bottom of the <em class="guilabel">Data</em> tab:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-edit.png" src="../../_images/sqlview-edit.png" />
</div>
<p>Once created, the SQL view layer is used in the same way as a conventional table-backed layer,
with the one limitation of being read-only.</p>
</div>
<div class="section" id="parameterizing-sql-views">
<h2>Parameterizing SQL Views<a class="headerlink" href="#parameterizing-sql-views" title="Permalink to this headline">¶</a></h2>
<p>A parametric SQL view is based on a SQL query containing named parameters.
The values for the parameters can be provided dynamically in WMS and WFS requests
using the <tt class="docutils literal"><span class="pre">viewparams</span></tt> request parameter.
Parameters can have default values specified,
to handle the situation where they are not supplied in a request.
Validation of supplied parameter values is supported by specifying validation regular expressions.
Parameter values are only accepted if they match the regular expression defined for them.
Appropriate parameter validation should always be used to avoid the risk of <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection attacks</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">SQL View parameter substitution should be used with caution, since improperly validated parameters open the risk of SQL injection attack.
Where possible, consider using safer methods such as <a class="reference internal" href="../../filter/index.html#filtering"><em>dynamic filtering</em></a> in the request, or <a class="reference internal" href="../../styling/sld-extensions/substitution.html#sld-variable-substitution"><em>Variable substitution in SLD</em></a>.</p>
</div>
<div class="section" id="defining-parameters">
<h3>Defining parameters<a class="headerlink" href="#defining-parameters" title="Permalink to this headline">¶</a></h3>
<p>Within the SQL View query, parameter names are delimited by leading and trailing <tt class="docutils literal"><span class="pre">%</span></tt> signs.
The parameters can occur anywhere within the query text,
including such uses as within SQL string constants,
in place of SQL keywords, or representing entire SQL clauses.</p>
<p>Here is an example of a SQL View query for a layer called <tt class="docutils literal"><span class="pre">popstates</span></tt> with two parameters, <tt class="docutils literal"><span class="pre">low</span></tt> and <tt class="docutils literal"><span class="pre">high</span></tt>:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-parametricsql.png" src="../../_images/sqlview-parametricsql.png" />
</div>
<p>Each parameter needs to be defined with its name, an optional default value, and a validation expression.
The <em class="guilabel">Guess parameters from SQL</em> link can be clicked to infer the query parameters automatically, or they can be entered manually.
The result is a table filled with the parameter names, default values and validation expressions:</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-paramdefault.png" src="../../_images/sqlview-paramdefault.png" />
</div>
<p>In this case the default values should be specified, since the query cannot be executed without values for the parameters (because the expanded query <tt class="docutils literal"><span class="pre">select</span> <span class="pre">gid,</span> <span class="pre">state_name,</span> <span class="pre">the_geom</span> <span class="pre">from</span> <span class="pre">pgstates</span> <span class="pre">where</span> <span class="pre">persons</span> <span class="pre">between</span> <span class="pre">and</span></tt> is invalid SQL).
Since the use of the parameters in the SQL query requires their values to be positive integer numbers, the validation regular expressions are specified to allow only numeric input (i.e. <tt class="docutils literal"><span class="pre">^[\d]+$</span></tt>):</p>
<div class="figure align-center">
<img alt="../../_images/sqlview-paramcustom.png" src="../../_images/sqlview-paramcustom.png" />
</div>
<p>Once the parameters have been defined,
the <strong>Attributes</strong> <em class="guilabel">Refresh</em> link is clicked to parse the query and retrieve the attribute columns.
The computed geometry type and column identifier details can be corrected if required.
From this point on the workflow is the same as for a non-parameterized query.</p>
</div>
<div class="section" id="using-a-parametric-sql-view">
<h3>Using a parametric SQL View<a class="headerlink" href="#using-a-parametric-sql-view" title="Permalink to this headline">¶</a></h3>
<p>The SQL view parameters are specified by adding the <tt class="docutils literal"><span class="pre">viewparams</span></tt> parameter to the WMS <tt class="docutils literal"><span class="pre">GetMap</span></tt>
or the WFS <tt class="docutils literal"><span class="pre">GetFeature</span></tt> request.
The <tt class="docutils literal"><span class="pre">viewparams</span></tt> argument is a list of <tt class="docutils literal"><span class="pre">key:value</span></tt> pairs, separated by semicolons:</p>
<blockquote>
<div><tt class="docutils literal"><span class="pre">viewparams=p1:v1;p2:v2;...</span></tt></div></blockquote>
<p>If the values contain semicolons or commas these must be escaped with a backslash (e.g. <tt class="docutils literal"><span class="pre">\,</span></tt> and <tt class="docutils literal"><span class="pre">\;</span></tt>).</p>
<p>For example, the <tt class="docutils literal"><span class="pre">popstates</span></tt> SQL View layer can be displayed by invoking the <a class="reference internal" href="../../webadmin/layerpreview/index.html#layerpreview"><em>Layer Preview</em></a>.
Initially no parameter values are supplied, so the defaults are used and all the states are displayed,</p>
<p>To display all states having more than 20 million inhabitatants the following parameter is added to the <tt class="docutils literal"><span class="pre">GetMap</span></tt> request: <tt class="docutils literal"><span class="pre">&amp;viewparams=low:20000000</span></tt></p>
<div class="figure align-center">
<img alt="../../_images/sqlview-20millions.png" src="../../_images/sqlview-20millions.png" />
</div>
<p>To display all states having between 2 and 5 millions inhabitatants the view parameters are: <tt class="docutils literal"><span class="pre">&amp;viewparams=low:2000000;high:5000000</span></tt></p>
<div class="figure align-center">
<img alt="../../_images/sqlview-2m-5m.png" src="../../_images/sqlview-2m-5m.png" />
</div>
<p>Parameters can be provided for multiple layers by separating each parameter map with a comma:</p>
<blockquote>
<div><tt class="docutils literal"><span class="pre">&amp;viewparams=l1p1:v1;l1p2:v2,l2p1:v1;l2p2:v2,...</span></tt></div></blockquote>
<p>The number of parameter maps must match the number of layers (featuretypes) included in the request.</p>
</div>
<div class="section" id="parameters-and-validation">
<h3>Parameters and validation<a class="headerlink" href="#parameters-and-validation" title="Permalink to this headline">¶</a></h3>
<p>The value of a SQL View parameter can be an arbitrary string of text.
The only constraint is that the attribute names and types returned by the view query must never change.
This makes it possible to create views containing parameters representing complex SQL fragments.
For example, using the view query <tt class="docutils literal"><span class="pre">select</span> <span class="pre">*</span> <span class="pre">from</span> <span class="pre">pgstates</span> <span class="pre">%where%</span></tt> allows specifying the WHERE clause of the query dynamically.
However, this would likely require an empty validation expression.
which presents a serious risk of <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection attacks</a>.
This technique should only be used if access to the server is restricted to trusted clients.</p>
<p>In general, SQL parameters must be used with care.
They should always include validation regular expressions that accept only the intended parameter values.
Note that while validation expressions should be constructed to prevent illegal values,
they do not necessarily have to ensure the values are syntactically correct,
since this will be checked by the database SQL parser.
For example:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">^[\d\.\+-eE]+$</span></tt> checks that a parameter value contains valid characters for floating-point numbers (including scientific notation), but does not check that the value is actually a valid number</li>
<li><tt class="docutils literal"><span class="pre">[^;']+</span></tt> checks that a parameter value does not contain quotes or semicolumn.  This prevents common SQL injection attacks, but otherwise does not impose much limitation on the actual value</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="resources-for-validation-regular-expressions">
<h3>Resources for Validation Regular expressions<a class="headerlink" href="#resources-for-validation-regular-expressions" title="Permalink to this headline">¶</a></h3>
<p>Defining effective validation regular expressions is important for security.
Regular expressions are a complex topic that cannot be fully addressed here.
The following are some resources for constructing regular expressions:</p>
<blockquote>
<div><ul class="simple">
<li>GeoServer uses the standard Java regular expression engine. The <a class="reference external" href="http://java.sun.com/javase/6/docs/api/java/util/regex/Pattern.html">Pattern class Javadocs</a> contain the full specification of the allowed syntax.</li>
<li><a class="reference external" href="http://www.regular-expressions.info">http://www.regular-expressions.info</a> has many tutorials and examples of regular expressions.</li>
<li>The <a class="reference external" href="http://myregexp.com/">myregexp</a> applet can be used to test regular expressions online.</li>
</ul>
</div></blockquote>
</div>
</div>
</div>


      <div class="selfclear pagination-nav">
          <div class="leftwise"><strong>Previous</strong>: <a href="jndi.html" title="previous chapter">JNDI</a></div>
          <div class="rightwise"><strong>Next</strong>: <a href="primarykey.html" title="next chapter">Controlling feature ID generation in spatial databases</a></div>
      </div>
      </div><!-- /#content> -->
  <div id="sidebar" class="contrast">
      <div id="toc" class="section">
        <h3 class="pngfix">Table Of Contents</h3>
        <ul>
<li><a class="reference internal" href="#">SQL Views</a><ul>
<li><a class="reference internal" href="#creating-a-sql-view">Creating a SQL View</a></li>
<li><a class="reference internal" href="#parameterizing-sql-views">Parameterizing SQL Views</a><ul>
<li><a class="reference internal" href="#defining-parameters">Defining parameters</a></li>
<li><a class="reference internal" href="#using-a-parametric-sql-view">Using a parametric SQL View</a></li>
<li><a class="reference internal" href="#parameters-and-validation">Parameters and validation</a></li>
<li><a class="reference internal" href="#resources-for-validation-regular-expressions">Resources for Validation Regular expressions</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section">
          <h3>Continue Reading</h3>
          <ul>
            <li>Previous: <a href="jndi.html" title="previous chapter">JNDI</a></li>
            <li>Next: <a href="primarykey.html" title="next chapter">Controlling feature ID generation in spatial databases</a></li>
          </ul>
        </div>
        <div class="section">
        <h3>This Page</h3>
        <ul class="this-page-menu">
          <li><a href="../../_sources/data/database/sqlview.txt">Show Source</a></li>
        </ul>
        </div>
  </div><!-- /#sidebar -->
  </div><!-- /.wrap> -->
</div><!-- /#main -->
<div id="footer">
  <div class="wrap">
    &copy; Copyright GeoServer.
    Last updated on Jan 04, 2013.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div><!-- /.wrap> -->
</div><!-- /#footer -->
  </body>
</html>